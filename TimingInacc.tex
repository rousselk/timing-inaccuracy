\documentclass[a4paper,10pt]{article}

\usepackage[T1]{fontenc}
\usepackage{rotfloat}

\title{Timing Inaccuracy in MSPSim Emulator: Consequences on COOJA Simulations}
\author{
K\'evin Roussel, Ye-Qiong Song and Olivier Zendra\\
LORIA/INRIA Nancy Grand-Est,\\
Universit\'e de Lorraine,\\
615, rue du Jardin Botanique,\\
54600 Villers-L\`es-Nancy, France\\
\texttt{\{Kevin.Roussel,Ye-Qiong.Song,Olivier.Zendra\}@inria.fr}
}
\date{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%                               80 COLONNES                                %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\maketitle

\abstract{
Xxx
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{COOJA and MSPSim}

Provided by the Contiki OS project~\cite{ContikiOS}, the COOJA network
simulator~\cite{Cooja} has become a widely used tool in the domain of
Wireless Sensor Networks (WSN). The research community especially uses
it extensively to perform simulations of small to relatively large wireless
networks of connected devices embedding sensors and/or actuators, commonly
named \emph{``motes''}, and thus to develop, debug and evaluate projects
based in the WSN technology.

COOJA itself is a Java-based application, providing three main features:
\begin{enumerate}
\item a graphical user interface (GUI, based on Java's standard Swing toolkit)
to design, run, and analyze WSN simulations;
\item simulation of the radio medium underlying the wireless communications
of sensor networks;
\item an extensible framework, which allows integration of external tools
to provide additional features to the COOJA application.
\end{enumerate}
This last feature is used to allow COOJA to actually emulate the various
motes constituting the WSNs. It indeed embeds and uses dedicated emulator
programs that perform cycle-exact emulation of the chips with which motes
are built: microcontroller units (MCUs), radio transceivers, etc.

This emulation mechanism is one of the main strong points of COOJA:
thanks to it, very fine-grained, precise and low-level simulations
can be performed; this is why COOJA has become a tool of choice especially
for debugging and evaluating WSN-related software (which happens to be
often based on Contiki OS).

Current versions of COOJA make use of two different emulator software
packages: Avrora for emulation of Atmel AVR-based devices, and
MSPSim~\cite{MSPSim} for emulation of TI MSP430-based devices.

Of these two emulators, MSPSim is currently the most used in literature
including COOJA-based simulations, since motes based on MSP430 MCUs are
more commonly distributed and used: we can especially think to the pervasive
TelosB/SkyMote family, or to Zolertia's Z1 platform.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Timing Inaccuracy Problem in MSPSim}

When performing our own simulations with virtual networks of MSP430-based
motes, we noticed timing inaccuracies in comparison to experiences made
on actual hardware. More precisely, we noticed that our simulations showed
unexplained delays during packet transmission (TX) over the radio medium,
that weren't observed during similar experiences on physical motes.
We then investigated the problem, and discovered the following results.

The problem concerns the emulation of the TI ChipCon CC2420 radio
transceiver by the MSPSim software package.

The differences appear on one precise operation: when loading packet data
into the transmission (TX) buffer of the emulated radio transceiver.
MSPSim, when emulating the CC2420 transceiver, performs TX buffer loading
much more slowly than the physical CC2420 chip actually does.

A simple example program, which only role is to load data packets
(110 bytes, that is: near the maximum size for IEEE
802.15.4\footnotemark[1] data packets), compiled for and run on
Zolertia Z1 hardware platform, clearly shows this timing difference.
The results of the comparison between execution on a simulted Z1 mote
in COOJA/MSPSim and on physical Z1 hardware is shown in
Table~\ref{TblTXPktLoadDelays} hereafter.

\footnotetext[1]{IEEE 802.15.4 is the standard defining the physical
layer (PHY) that the involved CC2420 radio transceiver---as well as
many others---communicates on. The absolute maximum size for IEEE
802.15.4 data packets is 127 8-bit bytes.}

\begin{sidewaystable}[!p]
\centering

\newcommand{\ticks}[1]{#1 ticks}
\newcommand{\moy}[1]{$\mu=$ \ticks{#1}}
\newcommand{\ect}[1]{$\sigma=$ \ticks{#1}}
\newcommand{\estus}[1]{($\approx$ #1 $\mu$sec.)}
\newcommand{\prctv}[1]{#1\% exp. value}

\begin{tabular}{|l|rr|rr|rcl|}
\hline
Pkt. Size & \multicolumn{2}{c|}{Cooja Simulation}
          & \multicolumn{2}{c|}{Hardware Experiment}
          & \multicolumn{3}{c|}{Mean Difference (under-estimation)} \\
\hline
 Moderate & \moy{6.4} & \ect{0.50} & \moy{7.2} & \ect{0.40}
          & 0.8 ticks & \estus{24} & \prctv{11.1} \\
 Medium   & \moy{10.7} & \ect{0.46} & \moy{12.7} & \ect{0.48}
          & 2.0 ticks & \estus{61} & \prctv{15.7} \\
 Large    & \moy{18.0} & \ect{0.00} & \moy{20.6} & \ect{0.49}
          & 2.6 ticks & \estus{79} & \prctv{12.6} \\
\hline
\end{tabular}
\\
Results with Contiki OS on SkyMote/TelosB hardware\\
\ \\

\begin{tabular}{|l|rr|rr|rcl|}
\hline
Pkt. Size & \multicolumn{2}{c|}{Cooja Simulation}
          & \multicolumn{2}{c|}{Hardware Experiment}
          & \multicolumn{3}{c|}{Mean Difference (under-estimation)} \\
\hline
 Moderate & \moy{5.0} & \ect{0.14} & \moy{2.3} & \ect{0.44}
          & 2.7 ticks & \estus{82} & \prctv{117.4} \\
 Medium   & \moy{8.9} & \ect{0.27} & \moy{4.2} & \ect{0.37}
          & 4.7 ticks & \estus{143} & \prctv{111.9} \\
 Large    & \moy{14.0} & \ect{0.14} & \moy{7.2} & \ect{0.39}
          & 6.8 ticks & \estus{208} & \prctv{94.4} \\
\hline
\end{tabular}
\\
Results with Contiki OS on Z1 hardware\\
\ \\

\begin{tabular}{|l|rr|rr|rcl|}
\hline
Pkt. Size & \multicolumn{2}{c|}{Cooja Simulation}
          & \multicolumn{2}{c|}{Hardware Experiment}
          & \multicolumn{3}{c|}{Mean Difference (under-estimation)} \\
\hline
 Moderate & \moy{58.0} & \ect{0.00} & \moy{50.3} & \ect{0.46}
          & 7.7 ticks & \estus{235} & \prctv{15.3} \\
 Medium   & \moy{85.2} & \ect{0.39} & \moy{73.6} & \ect{0.50}
          & 11.6 ticks & \estus{354} & \prctv{15.8} \\
 Large    & \moy{131.2} & \ect{0.39} & \moy{111.5} & \ect{0.51}
          & 19.7 ticks & \estus{601} & \prctv{17.7} \\
\hline
\end{tabular}
\\
Results with RIOT OS on SkyMote/TelosB hardware\\
\ \\

\begin{tabular}{|l|rr|rr|rcl|}
\hline
Pkt. Size & \multicolumn{2}{c|}{Cooja Simulation}
          & \multicolumn{2}{c|}{Hardware Experiment}
          & \multicolumn{3}{c|}{Mean Difference (under-estimation)} \\
\hline
 Moderate & \moy{46.0} & \ect{0.00} & \moy{16.2} & \ect{0.39}
          & 29.8 ticks & \estus{909} & \prctv{184.0} \\
 Medium   & \moy{69.0} & \ect{0.00} & \moy{24.2} & \ect{0.39}
          & 44.8 ticks & \estus{1367} & \prctv{185.1} \\
 Large    & \moy{106.8} & \ect{0.39} & \moy{38.0} & \ect{0.00}
          & 68.8 ticks & \estus{2100} & \prctv{181.1} \\
\hline
\end{tabular}
\\
Results with RIOT OS on Z1 hardware\\
\ \\

\caption{Delays observed for loading packets into CC2420 TX buffer,
using various software platforms and implementations.}
\label{TblTXPktLoadDelays}
\end{sidewaystable}

In Table~\ref{TblTXPktLoadDelays}, delay values are given in ``ticks'' of
\texttt{rtimer/hwtimer}, both of these timers incrementing at a rate of
32,768~Hz. The unit is thus a fixed period of time equal to about
30.5~microseconds.

These values are given for different operating systems---the well-known
Contiki already cited, as well as the very recent RIOT OS~\cite{RIOT},
which is also specialized in WSN---as well as for two kind of SPI drivers:
\begin{itemize}
\item a standard SPI driver, which waits for every transmitted byte to be
validated by the hardware SPI interface before sending the next one:
we also this the ``safe'' SPI access model, since it allows to detect
any problem that can occur during transmission on the SPU bus;
\item a so-called ``fast write'' SPI model, where a byte is written to
the bus every time the SPI hardware TX register is empty, without waiting
for the validation signals for the previous byte to be written: this is
the SPI write method used by the Contiki OS. While this allows for faster
writes on the SPI bus, it makes transfers---at least in theory---less
reliable. (Note however that while this method dramatically accelerates
SPI transmissions to the radio transceiver, it doesn't make the timing
differences observed between simulations and hardware runs disappear.)
\end{itemize}

We thus see that whatever the software environment used, the inaccuracy
in timing for the TX buffer loading operation is very important:
the simulated loading delay is always 2 to 3 times larger than
the actual delay on hardware!

Such a difference can be expected to have serious consequences on
the validity of evaluations made with COOJA simulations, more precisely
on time and performance evaluations.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Consequences}

We looked in recent literature, and found many recent articles (that is:
published in year 2014 or later) using COOJA simulations to evaluate
time-related performance of WSN projects. Among them, we can cite
the following:
\begin{itemize}
\item ...
\end{itemize}

Such studies, which rely on COOJA/MSPSim emulation runs to evaluate
time-related performance on WSN, have a high risk of suffering from
inexact results due to the inaccuracy describe hereabove, thus
possibly invalidating their discussions and conclusions.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusion}

Until a fix is made and published to correct this timing inaccuracy
in the MSPSim emulator, we believe the only way to get robust and reliable
results concerning timing and time-related performance evaluation is
to perform tests on actual hardware, which will eliminate any bias
that could be introduced by errors or inaccuracies in emulator software.

Of course, such hardware tests are much more difficult, long and
costly to prepare, run and analyze. That's why fixing the problem
we describe in the present paper should be done as soon as possible.

Many published articles in the domain of WSNs, including very recent
and current publications, rely on the COOJA/MSPSim simulation framework
to demonstrate the validity and evaluate the performances of research
projects. The validity of such publications is clearly put in jeopardy
by the problem we describe here, especially when time-related results
obtained by simulation are involved.

It is also however, a testimony of the usefulness of the COOJA/MSPSim
software package. Note also that while this problem impairs its use
as a performance evaluation tool, it does not affect its other applications,
like the ability to develop and debug WSN-related software much more easily
thanks to its emulation features.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\vfill
\bibliographystyle{unsrt}
{\small
\bibliography{TimingInacc}}

\end{document}
